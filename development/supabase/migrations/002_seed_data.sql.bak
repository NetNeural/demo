-- Seed data for NetNeural development environment
-- This populates the database with sample data for testing

-- NOTE: Seed data is disabled for initial setup
-- Run this manually after creating users through Supabase Auth

/*
-- Insert sample profiles first (normally these would be created by auth triggers)
INSERT INTO public.profiles (id, email, full_name, avatar_url) VALUES
    ('11111111-1111-1111-1111-111111111111', 'admin@netneural.ai', 'NetNeural Admin', 'https://avatars.githubusercontent.com/u/1?v=4'),
    ('22222222-2222-2222-2222-222222222222', 'demo@example.com', 'Demo User', 'https://avatars.githubusercontent.com/u/2?v=4'),
    ('33333333-3333-3333-3333-333333333333', 'developer@netneural.ai', 'NetNeural Developer', 'https://avatars.githubusercontent.com/u/3?v=4')
ON CONFLICT (id) DO NOTHING;

-- Sample organizations
INSERT INTO public.organizations (id, name, slug, description, owner_id) VALUES
    ('550e8400-e29b-41d4-a716-446655440000', 'NetNeural Labs', 'netneural-labs', 'AI-powered project management and collaboration platform', '11111111-1111-1111-1111-111111111111'),
    ('550e8400-e29b-41d4-a716-446655440001', 'Demo Company', 'demo-company', 'Sample organization for testing purposes', '22222222-2222-2222-2222-222222222222')
ON CONFLICT (id) DO NOTHING;

-- Sample projects
INSERT INTO public.projects (id, name, description, organization_id, created_by, status) VALUES
    ('660e8400-e29b-41d4-a716-446655440000', 'NetNeural Platform', 'Main platform development project', '550e8400-e29b-41d4-a716-446655440000', '11111111-1111-1111-1111-111111111111', 'active'),
    ('660e8400-e29b-41d4-a716-446655440001', 'Mobile App Development', 'React Native mobile application', '550e8400-e29b-41d4-a716-446655440000', '11111111-1111-1111-1111-111111111111', 'active'),
    ('660e8400-e29b-41d4-a716-446655440002', 'Documentation Website', 'User guides and API documentation', '550e8400-e29b-41d4-a716-446655440000', '11111111-1111-1111-1111-111111111111', 'active'),
    ('660e8400-e29b-41d4-a716-446655440003', 'Demo Project', 'Sample project for demonstrations', '550e8400-e29b-41d4-a716-446655440001', '22222222-2222-2222-2222-222222222222', 'active')
ON CONFLICT (id) DO NOTHING;

-- Sample tasks
INSERT INTO public.tasks (id, title, description, status, priority, project_id, created_by, due_date) VALUES
    ('770e8400-e29b-41d4-a716-446655440000', 'Set up Supabase infrastructure', 'Configure Supabase for authentication, database, and storage', 'completed', 'high', '660e8400-e29b-41d4-a716-446655440000', '11111111-1111-1111-1111-111111111111', '2025-08-15 00:00:00+00'),
    ('770e8400-e29b-41d4-a716-446655440001', 'Implement user authentication', 'Add sign up, sign in, and password reset functionality', 'in_progress', 'high', '660e8400-e29b-41d4-a716-446655440000', '11111111-1111-1111-1111-111111111111', '2025-08-20 00:00:00+00'),
    ('770e8400-e29b-41d4-a716-446655440002', 'Design project dashboard', 'Create responsive dashboard layout for project overview', 'todo', 'medium', '660e8400-e29b-41d4-a716-446655440000', '11111111-1111-1111-1111-111111111111', '2025-08-25 00:00:00+00'),
    ('770e8400-e29b-41d4-a716-446655440003', 'Implement task management', 'CRUD operations for tasks with real-time updates', 'todo', 'high', '660e8400-e29b-41d4-a716-446655440000', '11111111-1111-1111-1111-111111111111', '2025-08-30 00:00:00+00'),
    ('770e8400-e29b-41d4-a716-446655440004', 'Set up file storage', 'Configure file upload and management system', 'todo', 'medium', '660e8400-e29b-41d4-a716-446655440000', '11111111-1111-1111-1111-111111111111', '2025-09-05 00:00:00+00'),
    ('770e8400-e29b-41d4-a716-446655440005', 'Mobile app setup', 'Initialize React Native project with Expo', 'in_progress', 'medium', '660e8400-e29b-41d4-a716-446655440001', '11111111-1111-1111-1111-111111111111', '2025-08-18 00:00:00+00'),
    ('770e8400-e29b-41d4-a716-446655440006', 'API documentation', 'Document all API endpoints with examples', 'todo', 'low', '660e8400-e29b-41d4-a716-446655440002', '11111111-1111-1111-1111-111111111111', '2025-09-10 00:00:00+00')
ON CONFLICT (id) DO NOTHING;

-- Sample task comments
INSERT INTO public.task_comments (id, task_id, user_id, content) VALUES
    ('880e8400-e29b-41d4-a716-446655440000', '770e8400-e29b-41d4-a716-446655440000', '11111111-1111-1111-1111-111111111111', 'Supabase infrastructure is now fully configured with Docker Compose setup for local development and Unraid deployment.'),
    ('880e8400-e29b-41d4-a716-446655440001', '770e8400-e29b-41d4-a716-446655440001', '11111111-1111-1111-1111-111111111111', 'Working on the authentication flow. Supabase Auth is integrated with custom UI components.'),
    ('880e8400-e29b-41d4-a716-446655440002', '770e8400-e29b-41d4-a716-446655440005', '11111111-1111-1111-1111-111111111111', 'React Native project structure is ready. Need to add Supabase client configuration.')
ON CONFLICT (id) DO NOTHING;

-- Sample activity logs
INSERT INTO public.activity_logs (user_id, action, entity_type, entity_id, details) VALUES
    ('11111111-1111-1111-1111-111111111111', 'create', 'organization', '550e8400-e29b-41d4-a716-446655440000', '{"name": "NetNeural Labs"}'),
    ('11111111-1111-1111-1111-111111111111', 'create', 'project', '660e8400-e29b-41d4-a716-446655440000', '{"name": "NetNeural Platform"}'),
    ('11111111-1111-1111-1111-111111111111', 'create', 'task', '770e8400-e29b-41d4-a716-446655440000', '{"title": "Set up Supabase infrastructure"}'),
    ('11111111-1111-1111-1111-111111111111', 'update', 'task', '770e8400-e29b-41d4-a716-446655440000', '{"status": "completed"}'),
    ('22222222-2222-2222-2222-222222222222', 'create', 'organization', '550e8400-e29b-41d4-a716-446655440001', '{"name": "Demo Company"}');

-- Sample notifications
INSERT INTO public.notifications (user_id, title, message, type, action_url) VALUES
    ('11111111-1111-1111-1111-111111111111', 'Welcome to NetNeural!', 'Your account has been set up successfully. Start by creating your first project.', 'success', '/projects'),
    ('11111111-1111-1111-1111-111111111111', 'Task assigned', 'You have been assigned to "Implement user authentication"', 'info', '/tasks/770e8400-e29b-41d4-a716-446655440001'),
    ('11111111-1111-1111-1111-111111111111', 'Task due soon', 'Task "Implement user authentication" is due in 3 days', 'warning', '/tasks/770e8400-e29b-41d4-a716-446655440001');

-- Create a function to automatically create profiles when users sign up
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO public.profiles (id, email, full_name)
    VALUES (
        NEW.id,
        NEW.email,
        COALESCE(NEW.raw_user_meta_data->>'full_name', split_part(NEW.email, '@', 1))
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Create trigger to call the function when a new user signs up
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
    AFTER INSERT ON auth.users
    FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- Create a function to handle organization member auto-join
CREATE OR REPLACE FUNCTION public.handle_new_organization_member()
RETURNS TRIGGER AS $$
BEGIN
    -- Add the owner as an organization member with owner role
    IF TG_OP = 'INSERT' THEN
        INSERT INTO public.organization_members (organization_id, user_id, role)
        VALUES (NEW.id, NEW.owner_id, 'owner');
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Create trigger for organization member auto-join
DROP TRIGGER IF EXISTS on_organization_created ON public.organizations;
CREATE TRIGGER on_organization_created
    AFTER INSERT ON public.organizations
    FOR EACH ROW EXECUTE FUNCTION public.handle_new_organization_member();

-- Create a function to handle project member auto-join
CREATE OR REPLACE FUNCTION public.handle_new_project()
RETURNS TRIGGER AS $$
BEGIN
    -- Add the creator as a project member with manager role
    IF TG_OP = 'INSERT' AND NEW.created_by IS NOT NULL THEN
        INSERT INTO public.project_members (project_id, user_id, role)
        VALUES (NEW.id, NEW.created_by, 'manager');
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Create trigger for project member auto-join
DROP TRIGGER IF EXISTS on_project_created ON public.projects;
CREATE TRIGGER on_project_created
    AFTER INSERT ON public.projects
    FOR EACH ROW EXECUTE FUNCTION public.handle_new_project();

-- Create a function to log activities
CREATE OR REPLACE FUNCTION public.log_activity()
RETURNS TRIGGER AS $$
DECLARE
    activity_action TEXT;
    entity_name TEXT;
BEGIN
    -- Determine the action based on the trigger operation
    CASE TG_OP
        WHEN 'INSERT' THEN activity_action := 'create';
        WHEN 'UPDATE' THEN activity_action := 'update';
        WHEN 'DELETE' THEN activity_action := 'delete';
    END CASE;

    -- Get the entity name from the table name
    entity_name := TG_TABLE_NAME;

    -- Insert activity log for INSERT and UPDATE operations
    IF TG_OP = 'INSERT' OR TG_OP = 'UPDATE' THEN
        INSERT INTO public.activity_logs (
            user_id,
            action,
            entity_type,
            entity_id,
            details
        ) VALUES (
            auth.uid(),
            activity_action,
            entity_name,
            NEW.id,
            row_to_json(NEW)
        );
        RETURN NEW;
    END IF;

    -- Insert activity log for DELETE operations
    IF TG_OP = 'DELETE' THEN
        INSERT INTO public.activity_logs (
            user_id,
            action,
            entity_type,
            entity_id,
            details
        ) VALUES (
            auth.uid(),
            activity_action,
            entity_name,
            OLD.id,
            row_to_json(OLD)
        );
        RETURN OLD;
    END IF;

    RETURN NULL;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Create activity logging triggers
CREATE TRIGGER log_organization_activity
    AFTER INSERT OR UPDATE OR DELETE ON public.organizations
    FOR EACH ROW EXECUTE FUNCTION public.log_activity();

CREATE TRIGGER log_project_activity
    AFTER INSERT OR UPDATE OR DELETE ON public.projects
    FOR EACH ROW EXECUTE FUNCTION public.log_activity();

CREATE TRIGGER log_task_activity
    AFTER INSERT OR UPDATE OR DELETE ON public.tasks
    FOR EACH ROW EXECUTE FUNCTION public.log_activity();

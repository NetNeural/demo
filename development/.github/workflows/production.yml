name: Production Deployment

on:
  push:
    branches: [main]
    paths: ['development/**']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  prepare:
    name: ğŸ” Pre-deployment Checks
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      environment: ${{ steps.env.outputs.environment }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=production" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“Š Extract version
        id: version
        working-directory: development
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

  test:
    name: ğŸ§ª Production Test Suite
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: development

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: netneural_prod_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: development/package-lock.json

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: ğŸš€ Start Supabase local
        run: supabase start

      - name: ğŸ“Š Apply migrations
        run: supabase db push

      - name: ğŸ”§ Generate types
        run: npm run supabase:types

      - name: ğŸ§ª Run full test suite
        run: npm run test:coverage
        env:
          NODE_ENV: test

      - name: ğŸ—ï¸ Test production build
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL_PROD }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY_PROD }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY_PROD }}
          GOLIOTH_API_KEY: ${{ secrets.GOLIOTH_API_KEY_PROD }}

  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [prepare, test]
    environment:
      name: ${{ needs.prepare.outputs.environment }}
      url: https://platform.netneural.ai

    defaults:
      run:
        working-directory: development

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: development/package-lock.json

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: ğŸ”— Link to remote Supabase project
        run: supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: ğŸ“Š Run database migrations
        run: supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: ğŸ”§ Generate production TypeScript types
        run: supabase gen types typescript > src/lib/database.types.ts
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: ğŸ—ï¸ Build application
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL_PROD }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY_PROD }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY_PROD }}
          GOLIOTH_API_KEY: ${{ secrets.GOLIOTH_API_KEY_PROD }}
          GOLIOTH_PROJECT_ID: ${{ secrets.GOLIOTH_PROJECT_ID_PROD }}

      - name: ğŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: development/out
          cname: platform.netneural.ai
          commit_message: 'Deploy ${{ needs.prepare.outputs.version }} to production'

      - name: ğŸ·ï¸ Create Release Tag
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          release_name: NetNeural Platform v${{ needs.prepare.outputs.version }}
          body: |
            ## ğŸš€ NetNeural Platform v${{ needs.prepare.outputs.version }}

            **Deployment Date:** ${{ github.event.head_commit.timestamp }}
            **Commit:** ${{ github.sha }}
            **Environment:** ${{ needs.prepare.outputs.environment }}

            ### ğŸ“Š Build Information
            - **Node.js Version:** 20.x
            - **TypeScript:** Strict mode enabled
            - **Database:** PostgreSQL with migrations
            - **Platform:** GitHub Pages + Supabase

            ### ğŸ”— Links
            - [Live Platform](https://platform.netneural.ai)
            - [Technical Documentation](https://github.com/NetNeural/MonoRepo/blob/main/development/TECHNICAL_SPECIFICATION.md)
            - [Development Guide](https://github.com/NetNeural/MonoRepo/blob/main/development/README.md)
          draft: false
          prerelease: false

  health-check:
    name: ğŸ¥ Post-deployment Health Check
    runs-on: ubuntu-latest
    needs: [deploy]

    steps:
      - name: ğŸ” Check website availability
        uses: jtalk/url-health-check-action@v3
        with:
          url: https://platform.netneural.ai
          max-attempts: 5
          retry-delay: 30s
          retry-all: true

      - name: ğŸ” Check API endpoints
        run: |
          # Check health endpoint
          curl -f https://platform.netneural.ai/api/health || exit 1

          # Check auth endpoint
          curl -f https://platform.netneural.ai/api/auth/session || exit 1

          echo "âœ… All endpoints are healthy"

  notify:
    name: ğŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [prepare, deploy, health-check]
    if: always()

    steps:
      - name: ğŸ“Š Determine status
        id: status
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ] && [ "${{ needs.health-check.result }}" = "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=âœ… Deployment successful" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=âŒ Deployment failed" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“§ Send deployment notification
        uses: actions/github-script@v6
        with:
          script: |
            const status = '${{ steps.status.outputs.status }}';
            const message = '${{ steps.status.outputs.message }}';
            const version = '${{ needs.prepare.outputs.version }}';
            const environment = '${{ needs.prepare.outputs.environment }}';

            const emoji = status === 'success' ? 'ğŸš€' : 'ğŸ’¥';

            const body = `
            ## ${emoji} Deployment to ${environment}

            **Status:** ${message}
            **Version:** v${version}
            **Environment:** ${environment}
            **Commit:** \`${context.sha.substring(0, 7)}\`
            **Timestamp:** ${new Date().toISOString()}

            ${status === 'success' ? 
              'ğŸ”— **Live URL:** https://platform.netneural.ai' : 
              'ğŸ” **Check the logs:** [View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})'
            }
            `;

            // Create issue for deployment notification
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `${emoji} Deployment ${status} - v${version}`,
              body: body,
              labels: ['deployment', environment, status]
            });

  rollback:
    name: ğŸ”„ Rollback Option
    runs-on: ubuntu-latest
    needs: [deploy, health-check]
    if: failure() && github.ref == 'refs/heads/main'
    environment:
      name: production-rollback

    steps:
      - name: âš ï¸ Deployment Failed - Manual Rollback Required
        uses: actions/github-script@v6
        with:
          script: |
            const body = `
            ## ğŸš¨ Production Deployment Failed

            **Failed Workflow:** [${context.runNumber}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            **Commit:** \`${context.sha.substring(0, 7)}\`
            **Branch:** \`${context.ref}\`

            ### ğŸ”„ Rollback Instructions

            1. **Immediate Action Required:**
               - Review the failed workflow logs
               - Determine if manual rollback is needed

            2. **Manual Rollback Steps:**
               \`\`\`bash
               # Rollback to previous version
               git checkout main
               git reset --hard HEAD~1
               git push --force-with-lease
               \`\`\`

            3. **Alternative - Revert Specific Commit:**
               \`\`\`bash
               git revert ${context.sha}
               git push origin main
               \`\`\`

            ### ğŸ” Investigation
            - Check application logs
            - Verify database migrations
            - Test critical user flows
            - Monitor error rates

            **Auto-assign to:** @technical-lead @devops-team
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ URGENT: Production Deployment Failed - Rollback Required`,
              body: body,
              labels: ['urgent', 'production', 'deployment-failed', 'rollback'],
              assignees: ['technical-lead'] // Replace with actual usernames
            });

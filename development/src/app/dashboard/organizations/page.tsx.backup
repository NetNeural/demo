'use client'

import { useState, useEffect } from 'react'
import { useSearchParams } from 'next/navigation'

interface Integration {
  id: string
  name: string
  type: string
  status: string
}

interface Organization {
  id: string
  name: string
  description: string
  role: string
  deviceCount: number
  userCount: number
  alertCount: number
  status: string
  plan: string
  integrations: Integration[]
}

export default function OrganizationsPage() {
  const searchParams = useSearchParams()
  const [showManageOrg, setShowManageOrg] = useState(false)
  const [selectedOrgId, setSelectedOrgId] = useState('')
  const [showConfigModal, setShowConfigModal] = useState(false)
  const [showAddModal, setShowAddModal] = useState(false)
  const [selectedIntegration, setSelectedIntegration] = useState<Integration | null>(null)
  const [newIntegrationType, setNewIntegrationType] = useState('')

  useEffect(() => {
    const manageOrgId = searchParams.get('manage')
    if (manageOrgId) {
      setSelectedOrgId(manageOrgId)
      setShowManageOrg(true)
    }
  }, [searchParams])

  // Prevent body scroll when modals are open
  useEffect(() => {
    if (showConfigModal || showAddModal) {
      document.body.classList.add('modal-open')
    } else {
      document.body.classList.remove('modal-open')
    }
    
    // Cleanup on unmount
    return () => {
      document.body.classList.remove('modal-open')
    }
  }, [showConfigModal, showAddModal])

  // Integration management functions
  const handleConfigureIntegration = (integration: Integration) => {
    console.log('Configure button clicked for:', integration)
    console.log('Setting selectedIntegration to:', integration)
    setSelectedIntegration(integration)
    setShowConfigModal(true)
    console.log('Modal should now be visible')
  }

  const handleTestIntegration = async (integration: Integration) => {
    try {
      // Simulate API call
      alert(`Testing ${integration.name}...\n\nConnection successful! ✅\n\n${integration.type === 'golioth' ? 'Golioth API connection verified' : integration.type === 'email' ? 'SMTP server connection successful' : 'Webhook endpoint responded correctly'}`)
    } catch (error: unknown) {
      const errorMessage = error instanceof Error ? error.message : 'Unknown error'
      alert(`Test failed for ${integration.name}: ${errorMessage}`)
    }
  }

  const handleRemoveIntegration = (integration: Integration) => {
    if (confirm(`Are you sure you want to remove ${integration.name}?\n\nThis action cannot be undone and may affect your IoT devices and notifications.`)) {
      alert(`${integration.name} has been removed successfully.\n\nNote: This is a demo - no actual integration was removed.`)
    }
  }

  const handleAddIntegration = (type: string) => {
    setNewIntegrationType(type)
    setShowAddModal(true)
  }

  const organizations: Organization[] = [
    {
      id: 'org-1',
      name: 'NetNeural Corporation',
      description: 'Main corporate organization for NetNeural IoT Platform',
      role: 'Super Admin',
      deviceCount: 45,
      userCount: 12,
      alertCount: 3,
      status: 'active',
      plan: 'Enterprise',
      integrations: [
        { id: 'golioth-1', name: 'Golioth IoT Platform', type: 'golioth', status: 'active' },
        { id: 'email-1', name: 'Email Notifications', type: 'email', status: 'active' },
        { id: 'webhook-1', name: 'Custom Webhooks', type: 'webhook', status: 'inactive' }
      ]
    },
    {
      id: 'org-2',
      name: 'Industrial Solutions Ltd',
      description: 'Industrial IoT solutions and manufacturing automation',
      role: 'Organization Admin',
      deviceCount: 23,
      userCount: 8,
      alertCount: 1,
      status: 'active',
      plan: 'Professional',
      integrations: [
        { id: 'golioth-2', name: 'Golioth IoT Platform', type: 'golioth', status: 'active' }
      ]
    },
    {
      id: 'org-3',
      name: 'Smart Factory Co',
      description: 'Smart factory monitoring and optimization',
      role: 'User',
      deviceCount: 12,
      userCount: 5,
      alertCount: 0,
      status: 'active',
      plan: 'Standard',
      integrations: []
    }
  ]

  const selectedOrg = organizations.find(org => org.id === selectedOrgId)

  if (showManageOrg && selectedOrg) {
    return (
      <div className="dashboard-page">
        <div className="page-header">
          <div className="page-header-content">
            <button 
              className="btn btn-ghost btn-sm mb-2"
              onClick={() => setShowManageOrg(false)}
            >
              ← Back to Organizations
            </button>
            <h1 className="text-3xl font-bold text-gray-900 mb-2">
              Manage {selectedOrg.name}
            </h1>
            <p className="text-gray-600">Configure organization settings and integrations.</p>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="card">
            <div className="card-content">
              <h2 className="text-xl font-semibold text-gray-900 mb-4">Organization Details</h2>
              <div className="space-y-4">
                <div className="form-group">
                  <label className="form-label">Organization Name</label>
                  <input 
                    type="text" 
                    className="input" 
                    defaultValue={selectedOrg.name}
                    placeholder="Enter organization name"
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">Description</label>
                  <textarea 
                    className="input"
                    rows={3}
                    defaultValue={selectedOrg.description}
                    placeholder="Organization description"
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">Plan</label>
                  <select className="input" defaultValue={selectedOrg.plan} title="Organization plan">
                    <option value="Standard">Standard</option>
                    <option value="Professional">Professional</option>
                    <option value="Enterprise">Enterprise</option>
                  </select>
                </div>
                <button className="btn btn-primary w-full">Save Changes</button>
              </div>
            </div>
          </div>

          <div className="card">
            <div className="card-content">
              <h2 className="text-xl font-semibold text-gray-900 mb-4">Statistics</h2>
              <div className="grid grid-cols-2 gap-4">
                <div className="text-center p-4 bg-blue-50 rounded-lg">
                  <div className="text-2xl font-bold text-blue-600">{selectedOrg.deviceCount}</div>
                  <div className="text-sm text-gray-600">Devices</div>
                </div>
                <div className="text-center p-4 bg-green-50 rounded-lg">
                  <div className="text-2xl font-bold text-green-600">{selectedOrg.userCount}</div>
                  <div className="text-sm text-gray-600">Users</div>
                </div>
                <div className="text-center p-4 bg-yellow-50 rounded-lg">
                  <div className="text-2xl font-bold text-yellow-600">{selectedOrg.alertCount}</div>
                  <div className="text-sm text-gray-600">Alerts</div>
                </div>
                <div className="text-center p-4 bg-purple-50 rounded-lg">
                  <div className="text-2xl font-bold text-purple-600">{selectedOrg.integrations.length}</div>
                  <div className="text-sm text-gray-600">Integrations</div>
                </div>
              </div>
              <div className="mt-4 space-y-2">
                <button className="btn btn-secondary btn-sm w-full">View Devices</button>
                <button className="btn btn-secondary btn-sm w-full">Manage Users</button>
                <button className="btn btn-secondary btn-sm w-full">View Alerts</button>
              </div>
            </div>
          </div>

          <div className="card">
            <div className="card-content">
              <h2 className="text-xl font-semibold text-gray-900 mb-4">Quick Actions</h2>
              <div className="space-y-3">
                <button className="btn btn-outline w-full text-left">Add Integration</button>
                <button className="btn btn-outline w-full text-left">Invite User</button>
                <button className="btn btn-outline w-full text-left">Generate Report</button>
                <button className="btn btn-outline w-full text-left">Organization Settings</button>
              </div>
            </div>
          </div>
        </div>

        <div className="card mt-6">
          <div className="card-content">
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-semibold text-gray-900">Integration Management</h2>
              <div className="flex items-center space-x-2">
                <span className="text-sm text-gray-500">Organization:</span>
                <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                  {selectedOrg.name}
                </span>
              </div>
            </div>
              
            <div className="integration-section">
              <h3 className="text-lg font-medium text-gray-900 mb-3">Active Integrations ({selectedOrg.integrations.length})</h3>
              
              {selectedOrg.integrations.length === 0 ? (
                <div className="no-integrations bg-gray-50 p-6 rounded-lg text-center">
                  <p className="text-gray-600 mb-3">No integrations configured for this organization.</p>
                  <p className="text-sm text-gray-500">Add integrations below to connect external services.</p>
                </div>
              ) : (
                <div className="integration-list space-y-3 mb-6">
                  {selectedOrg.integrations.map(integration => (
                    <div key={integration.id} className="integration-item bg-white border rounded-lg p-4">
                      <div className="flex items-center justify-between">
                        <div className="integration-info">
                          <h4 className="text-lg font-medium text-gray-900">{integration.name}</h4>
                          <p className="text-sm text-gray-600">
                            {integration.type === 'golioth' && 'Golioth IoT Platform Integration'}
                            {integration.type === 'email' && 'SMTP Email Notifications'}
                            {integration.type === 'webhook' && 'Custom Webhook Endpoint'}
                          </p>
                          <span className={`inline-block mt-2 px-2 py-1 text-xs rounded-full ${
                            integration.status === 'active' 
                              ? 'bg-green-100 text-green-800' 
                              : 'bg-yellow-100 text-yellow-800'
                          }`}>
                            {integration.status}
                          </span>
                        </div>
                        <div className="integration-actions space-x-2">
                          <button 
                            className="btn btn-secondary btn-sm"
                            onClick={() => handleConfigureIntegration(integration)}
                          >
                            Configure
                          </button>
                          <button 
                            className="btn btn-ghost btn-sm"
                            onClick={() => handleTestIntegration(integration)}
                          >
                            Test
                          </button>
                          <button 
                            className="btn btn-ghost btn-sm text-red-600"
                            onClick={() => handleRemoveIntegration(integration)}
                          >
                            Remove
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            <div className="integration-section">
              <h3 className="text-lg font-medium text-gray-900 mb-3">Add New Integration</h3>
              <div className="integration-options grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="integration-option border rounded-lg p-4 hover:bg-gray-50 transition-colors">
                  <div className="integration-info mb-3">
                    <h4 className="font-medium text-gray-900">Golioth IoT Platform</h4>
                    <p className="text-sm text-gray-600">Connect your Golioth devices and projects</p>
                  </div>
                  <button 
                    className="btn btn-primary btn-sm w-full"
                    onClick={() => handleAddIntegration('golioth')}
                  >
                    + Add Golioth Integration
                  </button>
                </div>
                
                <div className="integration-option border rounded-lg p-4 hover:bg-gray-50 transition-colors">
                  <div className="integration-info mb-3">
                    <h4 className="font-medium text-gray-900">Email Notifications</h4>
                    <p className="text-sm text-gray-600">Configure SMTP for alert notifications</p>
                  </div>
                  <button 
                    className="btn btn-primary btn-sm w-full"
                    onClick={() => handleAddIntegration('email')}
                  >
                    + Add Email Integration
                  </button>
                </div>
                
                <div className="integration-option border rounded-lg p-4 hover:bg-gray-50 transition-colors">
                  <div className="integration-info mb-3">
                    <h4 className="font-medium text-gray-900">Custom Webhooks</h4>
                    <p className="text-sm text-gray-600">Send data to external systems</p>
                  </div>
                  <button 
                    className="btn btn-primary btn-sm w-full"
                    onClick={() => handleAddIntegration('webhook')}
                  >
                    + Add Webhook Integration
                  </button>
                </div>
                
                <div className="integration-option border rounded-lg p-4 hover:bg-gray-50 transition-colors">
                  <div className="integration-info mb-3">
                    <h4 className="font-medium text-gray-900">AWS IoT Core</h4>
                    <p className="text-sm text-gray-600">Integrate with AWS IoT services</p>
                  </div>
                  <button 
                    className="btn btn-primary btn-sm w-full"
                    onClick={() => handleAddIntegration('aws')}
                  >
                    + Add AWS IoT
                  </button>
                </div>
                
                <div className="integration-option border rounded-lg p-4 hover:bg-gray-50 transition-colors">
                  <div className="integration-info mb-3">
                    <h4 className="font-medium text-gray-900">Microsoft Azure IoT</h4>
                    <p className="text-sm text-gray-600">Connect to Azure IoT Hub</p>
                  </div>
                  <button 
                    className="btn btn-primary btn-sm w-full"
                    onClick={() => handleAddIntegration('azure')}
                  >
                    + Add Azure IoT
                  </button>
                </div>
                
                <div className="integration-option border rounded-lg p-4 hover:bg-gray-50 transition-colors">
                  <div className="integration-info mb-3">
                    <h4 className="font-medium text-gray-900">Slack Notifications</h4>
                    <p className="text-sm text-gray-600">Send alerts to Slack channels</p>
                  </div>
                  <button 
                    className="btn btn-primary btn-sm w-full"
                    onClick={() => handleAddIntegration('slack')}
                  >
                    + Add Slack
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    )
  }

  return (
    <>
      <div className="dashboard-page">
        <div className="page-header">
          <div className="page-header-content">
            <h1 className="text-3xl font-bold text-gray-900 mb-2">Organizations</h1>
            <p className="text-gray-600">Manage your organizations and integrations.</p>
          </div>
        </div>

        <div className="organizations-grid">
          {organizations.map(org => (
            <div key={org.id} className="org-card">
              <div className="org-card-header">
                <div className="org-card-title">
                  <h3 className="text-xl font-semibold text-gray-900">{org.name}</h3>
                  <span className="badge badge-success">{org.status}</span>
                </div>
                <span className="org-role-badge badge badge-secondary">{org.role}</span>
              </div>
              
              <div className="org-card-content">
                <p className="text-gray-600 mb-4">{org.description}</p>
                
                <div className="org-stats-grid">
                  <div className="org-stat">
                    <span className="stat-value">{org.deviceCount}</span>
                    <span className="stat-label">Devices</span>
                  </div>
                  <div className="org-stat">
                    <span className="stat-value">{org.userCount}</span>
                    <span className="stat-label">Users</span>
                  </div>
                  <div className="org-stat">
                    <span className="stat-value">{org.alertCount}</span>
                    <span className="stat-label">Alerts</span>
                  </div>
                  <div className="org-stat">
                    <span className="stat-value">{org.integrations.length}</span>
                    <span className="stat-label">Integrations</span>
                  </div>
                </div>
                
                <div className="integration-preview">
                  <p className="text-sm text-gray-600">
                    <strong>Integrations:</strong> {org.integrations.length > 0 
                      ? org.integrations.map(i => i.name).join(', ')
                      : 'None configured'}
                  </p>
                </div>
              </div>
              
              <div className="org-card-actions">
                <button className="btn btn-primary btn-sm">Switch To</button>
                <button 
                  className="btn btn-secondary btn-sm"
                  onClick={() => {
                    setSelectedOrgId(org.id)
                    setShowManageOrg(true)
                  }}
                >
                  Manage
                </button>
              </div>
            </div>
          ))}
        </div>
      </div>
      
      
      {/* Debug: Simple modal to test visibility */}
      {showConfigModal && (
        <div className="fixed top-4 right-4 bg-red-500 text-white p-4 rounded z-50">
          Modal State: {showConfigModal ? 'OPEN' : 'CLOSED'}<br/>
          Selected Integration: {selectedIntegration ? selectedIntegration.name : 'NONE'}
        </div>
      )}
      
      {/* Configuration Modal - Now at root level for proper overlay */}
      {showConfigModal && selectedIntegration && (
        <div 
          className=\"fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center modal-overlay z-50\"
          onClick={(e) => {
            if (e.target === e.currentTarget) {
              setShowConfigModal(false)
            }
          }}
        >
          <div className="bg-white rounded-lg p-6 w-full max-w-md mx-4 shadow-2xl modal-content relative">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-semibold text-gray-900">
                Configure {selectedIntegration.name}
              </h3>
              <button 
                onClick={() => setShowConfigModal(false)}
                className="text-gray-400 hover:text-gray-600 text-xl w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors absolute top-4 right-4"
                title="Close"
              >
                ✕
              </button>
            </div>
            
            <div className="space-y-4">
              {selectedIntegration.type === 'golioth' && (
                <>
                  <div className="form-group">
                    <label className="form-label">Golioth API Key</label>
                    <input type="password" className="input" placeholder="Enter your Golioth API key" />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Project ID</label>
                    <input type="text" className="input" placeholder="Enter project ID" />
                  </div>
                </>
              )}
              
              {selectedIntegration.type === 'email' && (
                <>
                  <div className="form-group">
                    <label className="form-label">SMTP Server</label>
                    <input type="text" className="input" placeholder="smtp.example.com" />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Port</label>
                    <input type="number" className="input" placeholder="587" />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Username</label>
                    <input type="email" className="input" placeholder="your-email@example.com" />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Password</label>
                    <input type="password" className="input" placeholder="Enter password" />
                  </div>
                </>
              )}
              
              {selectedIntegration.type === 'webhook' && (
                <>
                  <div className="form-group">
                    <label className="form-label">Webhook URL</label>
                    <input type="url" className="input" placeholder="https://api.example.com/webhook" />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Secret Key</label>
                    <input type="password" className="input" placeholder="Optional secret key" />
                  </div>
                </>
              )}
            </div>
            
            <div className="flex justify-end space-x-3 mt-6">
              <button 
                onClick={() => setShowConfigModal(false)}
                className="btn btn-ghost"
              >
                Cancel
              </button>
              <button 
                onClick={() => {
                  alert(`${selectedIntegration.name} configuration saved successfully!`)
                  setShowConfigModal(false)
                }}
                className="btn btn-primary"
              >
                Save Configuration
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* Add Integration Modal - Now at root level for proper overlay */}
      {showAddModal && (
        <div 
          className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay"
          onClick={(e) => {
            if (e.target === e.currentTarget) {
              setShowAddModal(false)
            }
          }}
        >
          <div className="bg-white rounded-lg p-6 w-full max-w-md mx-4 shadow-2xl max-h-[90vh] overflow-y-auto modal-content">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-semibold text-gray-900">
                Add {newIntegrationType.charAt(0).toUpperCase() + newIntegrationType.slice(1)} Integration
              </h3>
              <button 
                onClick={() => setShowAddModal(false)}
                className="text-gray-400 hover:text-gray-600 text-xl w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors"
                title="Close"
              >
                ✕
              </button>
            </div>
            
            <div className="space-y-4">
              <div className="form-group">
                <label className="form-label">Integration Name</label>
                <input 
                  type="text" 
                  className="input" 
                  placeholder={`My ${newIntegrationType.charAt(0).toUpperCase() + newIntegrationType.slice(1)} Integration`} 
                />
              </div>
              
              {newIntegrationType === 'golioth' && (
                <>
                  <div className="form-group">
                    <label className="form-label">Golioth API Key</label>
                    <input type="password" className="input" placeholder="Enter your Golioth API key" />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Project ID</label>
                    <input type="text" className="input" placeholder="Enter project ID" />
                  </div>
                </>
              )}
              
              {newIntegrationType === 'email' && (
                <>
                  <div className="form-group">
                    <label className="form-label">SMTP Server</label>
                    <input type="text" className="input" placeholder="smtp.example.com" />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Port</label>
                    <input type="number" className="input" placeholder="587" />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Username</label>
                    <input type="email" className="input" placeholder="your-email@example.com" />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Password</label>
                    <input type="password" className="input" placeholder="Enter password" />
                  </div>
                </>
              )}
              
              {newIntegrationType === 'webhook' && (
                <>
                  <div className="form-group">
                    <label className="form-label">Webhook URL</label>
                    <input type="url" className="input" placeholder="https://api.example.com/webhook" />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Secret Key</label>
                    <input type="password" className="input" placeholder="Optional secret key" />
                  </div>
                </>
              )}
              
              {newIntegrationType === 'aws' && (
                <>
                  <div className="form-group">
                    <label className="form-label">AWS Access Key ID</label>
                    <input type="password" className="input" placeholder="Enter AWS Access Key ID" />
                  </div>
                  <div className="form-group">
                    <label className="form-label">AWS Secret Access Key</label>
                    <input type="password" className="input" placeholder="Enter AWS Secret Access Key" />
                  </div>
                  <div className="form-group">
                    <label className="form-label">AWS Region</label>
                    <select className="input" title="AWS Region">
                      <option value="us-east-1">US East (N. Virginia)</option>
                      <option value="us-west-2">US West (Oregon)</option>
                      <option value="eu-west-1">Europe (Ireland)</option>
                      <option value="ap-southeast-1">Asia Pacific (Singapore)</option>
                    </select>
                  </div>
                </>
              )}
              
              {newIntegrationType === 'azure' && (
                <>
                  <div className="form-group">
                    <label className="form-label">Azure IoT Hub Connection String</label>
                    <input type="password" className="input" placeholder="HostName=...;SharedAccessKeyName=...;SharedAccessKey=..." />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Resource Group</label>
                    <input type="text" className="input" placeholder="Enter resource group name" />
                  </div>
                </>
              )}
              
              {newIntegrationType === 'slack' && (
                <>
                  <div className="form-group">
                    <label className="form-label">Slack Webhook URL</label>
                    <input type="url" className="input" placeholder="https://hooks.slack.com/services/..." />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Default Channel</label>
                    <input type="text" className="input" placeholder="#alerts" />
                  </div>
                </>
              )}
            </div>
            
            <div className="flex justify-end space-x-3 mt-6">
              <button 
                onClick={() => setShowAddModal(false)}
                className="btn btn-ghost"
              >
                Cancel
              </button>
              <button 
                onClick={() => {
                  alert(`${newIntegrationType.charAt(0).toUpperCase() + newIntegrationType.slice(1)} integration added successfully!\n\nNote: This is a demo - no actual integration was created.`)
                  setShowAddModal(false)
                }}
                className="btn btn-primary"
              >
                Add Integration
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  )
}

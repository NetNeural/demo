name: Fix Storage Error 42P17

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to fix'
        required: true
        type: choice
        options:
          - staging
          - production
        default: staging

jobs:
  fix-storage:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: development/package-lock.json

      - name: Install dependencies
        working-directory: development
        run: npm ci

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Apply storage fix SQL
        working-directory: development
        env:
          SUPABASE_URL: ${{ inputs.environment == 'staging' && secrets.STAGING_SUPABASE_URL || secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ inputs.environment == 'staging' && secrets.STAGE_SUPABASE_SERVICE_ROLE_KEY || secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_ACCESS_TOKEN: ${{ inputs.environment == 'staging' && secrets.STAGING_SUPABASE_ACCESS_TOKEN || secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ inputs.environment == 'staging' && secrets.STAGING_SUPABASE_PROJECT_ID || secrets.SUPABASE_PROJECT_ID }}
        run: |
          echo "Applying storage fix to ${{ inputs.environment }}..."
          
          # Link to project
          npx supabase link --project-ref $SUPABASE_PROJECT_ID
          
          # Apply the migration (use the new migration file instead of script)
          npx supabase db push --include-all

      - name: Verify fix
        working-directory: development
        env:
          SUPABASE_ACCESS_TOKEN: ${{ inputs.environment == 'staging' && secrets.STAGING_SUPABASE_ACCESS_TOKEN || secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "Verifying storage bucket was created..."
          
          # Check if bucket exists using Supabase REST API
          PROJECT_REF=$(npx supabase status | grep "API URL" | cut -d'/' -f3 | cut -d'.' -f1)
          echo "Project ref: $PROJECT_REF"
          
          # List buckets
          curl -s "https://$PROJECT_REF.supabase.co/storage/v1/bucket" \
            -H "Authorization: Bearer $SUPABASE_ACCESS_TOKEN" \
            | jq '.[] | select(.id == "organization-assets")

      - name: Summary
        run: |
          echo "## âœ… Storage Fix Applied" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Applied fix to **${{ inputs.environment }}** environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What was fixed:" >> $GITHUB_STEP_SUMMARY
          echo "- Created/verified \`organization-assets\` bucket" >> $GITHUB_STEP_SUMMARY
          echo "- Applied 4 storage policies (SELECT, INSERT, UPDATE, DELETE)" >> $GITHUB_STEP_SUMMARY
          echo "- Set file size limit to 512KB" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test uploading a logo:" >> $GITHUB_STEP_SUMMARY
          echo "Go to: https://demo-stage.netneural.ai/dashboard/organizations" >> $GITHUB_STEP_SUMMARY

# Deploy & invoke the daily-report and assessment-report edge functions
# on the STAGING Supabase project, then send the executive emails.
# Trigger: workflow_dispatch (manual only)

name: Run Executive Email Reports

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Which report(s) to send'
        required: true
        default: 'both'
        type: choice
        options:
          - both
          - daily-report
          - assessment-report
      preview_only:
        description: 'Preview only (do not send email)'
        required: false
        default: false
        type: boolean

jobs:
  deploy-and-send:
    runs-on: ubuntu-latest
    steps:
      # ‚îÄ‚îÄ Step 1: Checkout code (main has the function source) ‚îÄ‚îÄ
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      # ‚îÄ‚îÄ Step 2: Deploy the two report edge functions ‚îÄ‚îÄ
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Deploy daily-report function
        if: ${{ inputs.target == 'both' || inputs.target == 'daily-report' }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        working-directory: development
        run: |
          echo "üöÄ Deploying daily-report edge function..."
          npx supabase functions deploy daily-report \
            --project-ref atgbmxicqikmapfqouco \
            --no-verify-jwt
          echo "‚úÖ daily-report deployed"

      - name: Deploy assessment-report function
        if: ${{ inputs.target == 'both' || inputs.target == 'assessment-report' }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        working-directory: development
        run: |
          echo "üöÄ Deploying assessment-report edge function..."
          npx supabase functions deploy assessment-report \
            --project-ref atgbmxicqikmapfqouco \
            --no-verify-jwt
          echo "‚úÖ assessment-report deployed"

      # ‚îÄ‚îÄ Step 3: Wait for functions to become available ‚îÄ‚îÄ
      - name: Wait for deploy propagation
        run: sleep 10

      # ‚îÄ‚îÄ Step 4: Invoke daily-report ‚îÄ‚îÄ
      - name: Send Daily Platform Report
        if: ${{ inputs.target == 'both' || inputs.target == 'daily-report' }}
        run: |
          echo "üìä Invoking daily-report edge function..."
          QUERY=""
          if [ "${{ inputs.preview_only }}" = "true" ]; then
            QUERY="?preview=true"
          fi

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            "${{ secrets.STAGING_SUPABASE_URL }}/functions/v1/daily-report${QUERY}" \
            -H "Authorization: Bearer ${{ secrets.STAGING_SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "apikey: ${{ secrets.STAGING_SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{}')

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"

          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "‚ùå daily-report failed with HTTP $HTTP_CODE"
            exit 1
          fi
          echo "‚úÖ daily-report sent successfully"

      # ‚îÄ‚îÄ Step 5: Invoke assessment-report ‚îÄ‚îÄ
      - name: Send Assessment Report
        if: ${{ inputs.target == 'both' || inputs.target == 'assessment-report' }}
        run: |
          echo "üìã Invoking assessment-report edge function..."
          QUERY=""
          if [ "${{ inputs.preview_only }}" = "true" ]; then
            QUERY="?preview=true"
          fi

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            "${{ secrets.STAGING_SUPABASE_URL }}/functions/v1/assessment-report${QUERY}" \
            -H "Authorization: Bearer ${{ secrets.STAGING_SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "apikey: ${{ secrets.STAGING_SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{}')

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"

          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "‚ùå assessment-report failed with HTTP $HTTP_CODE"
            exit 1
          fi
          echo "‚úÖ assessment-report sent successfully"
